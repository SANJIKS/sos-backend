{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è{% endblock %}

{% block extrastyle %}
<style>
    .two-factor-container {
        max-width: 400px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .two-factor-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .two-factor-header h1 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .two-factor-header p {
        color: #666;
        font-size: 14px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }
    
    .form-group input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        text-align: center;
        letter-spacing: 2px;
    }
    
    .form-group input[type="text"]:focus {
        outline: none;
        border-color: #007cba;
        box-shadow: 0 0 0 2px rgba(0,124,186,0.2);
    }
    
    .checkbox-group {
        margin: 20px 0;
    }
    
    .checkbox-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
        cursor: pointer;
    }
    
    .checkbox-group input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .btn-primary {
        background-color: #007cba;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #005a87;
    }
    
    .btn-secondary {
        background-color: #f0f0f0;
        color: #333;
        margin-top: 10px;
    }
    
    .btn-secondary:hover {
        background-color: #e0e0e0;
    }
    
    .backup-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
        font-size: 14px;
        color: #666;
    }
    
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 14px;
    }
    
    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="two-factor-container">
    <div class="two-factor-header">
        <h1>üîê –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à email</p>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" id="2fa-form">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
            <input type="text" id="code" name="code" maxlength="6" placeholder="000000" required autocomplete="off">
        </div>
        
        {% if backup_codes_count > 0 %}
        <div class="backup-info">
            <strong>üí° –£ –≤–∞—Å –µ—Å—Ç—å {{ backup_codes_count }} —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤</strong><br>
            –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ email, –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥.
        </div>
        
        <div class="checkbox-group">
            <label>
                <input type="checkbox" name="use_backup_code" id="use_backup_code">
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥
            </label>
        </div>
        {% endif %}
        
        <button type="submit" class="btn btn-primary" id="submit-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </form>
    
    <button type="button" class="btn btn-secondary" onclick="sendCode()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥</button>
    
    <div style="text-align: center; margin-top: 20px;">
        <form method="post" action="{% url 'admin:logout' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" style="background: none; border: none; color: #666; text-decoration: none; font-size: 14px; cursor: pointer; padding: 0;">
                üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
            </button>
        </form>
    </div>
</div>

<script>
function sendCode() {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    fetch('{% url "2fa_admin_send_code" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    });
}

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
document.getElementById('code').focus();

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–≤–æ–¥–∞ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä
document.getElementById('code').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –≤–≤–æ–¥–µ 6 —Ü–∏—Ñ—Ä
document.getElementById('code').addEventListener('input', function(e) {
    if (this.value.length === 6) {
        submitForm();
    }
});

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
function submitForm() {
    const form = document.getElementById('2fa-form');
    const submitBtn = document.getElementById('submit-btn');
    const code = document.getElementById('code').value;
    const useBackupCode = document.getElementById('use_backup_code').checked;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    submitBtn.disabled = true;
    submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
    
    // –°–æ–∑–¥–∞–µ–º FormData
    const formData = new FormData();
    formData.append('code', code);
    formData.append('use_backup_code', useBackupCode ? 'on' : '');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        if (response.redirected) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç, –∑–Ω–∞—á–∏—Ç —É—Å–ø–µ—à–Ω–æ
            window.location.href = response.url;
        } else if (response.headers.get('content-type')?.includes('application/json')) {
            // –ï—Å–ª–∏ JSON –æ—Ç–≤–µ—Ç
            return response.json().then(data => {
                if (data.success && data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.reload();
                }
            });
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
document.getElementById('2fa-form').addEventListener('submit', function(e) {
    e.preventDefault();
    submitForm();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
function logout() {
    // –û—á–∏—â–∞–µ–º cookies –∏ —Å–µ—Å—Å–∏—é
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞
    window.location.replace('/admin/login/');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏
window.addEventListener('online', function() {
    console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
});

window.addEventListener('offline', function() {
    alert('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
});
</script>
{% endblock %} 